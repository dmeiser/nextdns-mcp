name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  actions: read
  checks: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run on dependabot PRs
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Wait for required workflows
        uses: actions/github-script@v7
        id: check-workflows
        with:
          script: |
            const required_workflows = ['Unit Tests', 'E2E MCP Gateway'];
            const pr_number = context.issue.number;
            const max_wait_minutes = 20;
            const check_interval_seconds = 30;
            const max_checks = (max_wait_minutes * 60) / check_interval_seconds;
            
            console.log(`Waiting for required workflows on PR #${pr_number}`);
            console.log(`Required: ${required_workflows.join(', ')}`);
            
            for (let check = 0; check < max_checks; check++) {
              // Get the PR to find the head SHA
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number
              });
              
              const head_sha = pr.data.head.sha;
              
              // Get all workflow runs for this SHA
              const workflows = await github.rest.actions.listWorkflowRunsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head_sha: head_sha,
                per_page: 100
              });
              
              // Check status of each required workflow
              const workflow_status = {};
              for (const workflow_name of required_workflows) {
                const matching_runs = workflows.data.workflow_runs.filter(
                  run => run.name === workflow_name && run.head_sha === head_sha
                );
                
                if (matching_runs.length === 0) {
                  workflow_status[workflow_name] = 'not_started';
                  continue;
                }
                
                // Get the most recent run
                const latest_run = matching_runs.sort((a, b) => 
                  new Date(b.created_at) - new Date(a.created_at)
                )[0];
                
                workflow_status[workflow_name] = {
                  status: latest_run.status,
                  conclusion: latest_run.conclusion
                };
              }
              
              console.log(`Check ${check + 1}/${max_checks}:`, JSON.stringify(workflow_status, null, 2));
              
              // Check if all workflows completed successfully
              const all_completed = required_workflows.every(
                workflow => workflow_status[workflow]?.status === 'completed'
              );
              
              const all_successful = required_workflows.every(
                workflow => workflow_status[workflow]?.conclusion === 'success'
              );
              
              if (all_completed && all_successful) {
                console.log('✅ All required workflows passed!');
                return { 
                  success: true, 
                  pr_number, 
                  pr_title: pr.data.title 
                };
              }
              
              if (all_completed && !all_successful) {
                console.log('❌ Some workflows failed');
                const failed = required_workflows.filter(
                  workflow => workflow_status[workflow]?.conclusion !== 'success'
                );
                return { 
                  success: false, 
                  reason: `Workflows failed: ${failed.join(', ')}` 
                };
              }
              
              // Wait before next check
              if (check < max_checks - 1) {
                console.log(`Waiting ${check_interval_seconds} seconds before next check...`);
                await new Promise(resolve => setTimeout(resolve, check_interval_seconds * 1000));
              }
            }
            
            console.log('⏱️ Timeout waiting for workflows');
            return { 
              success: false, 
              reason: 'Timeout waiting for workflows to complete' 
            };

      - name: Check if should skip
        if: fromJSON(steps.check-workflows.outputs.result).success == true
        id: skip-check
        run: |
          PR_TITLE='${{ fromJSON(steps.check-workflows.outputs.result).pr_title }}'
          
          # Check if this is a Python version update (exclude from auto-merge)
          if echo "$PR_TITLE" | grep -qi "bump python from"; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "skip_reason=Python version updates require manual review" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if this is a poetry/pip dependency (Python package)
          if ! echo "$PR_TITLE" | grep -q "deps(poetry)"; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "skip_reason=Not a Python package update" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "should_skip=false" >> $GITHUB_OUTPUT

      - name: Approve and enable auto-merge
        if: |
          fromJSON(steps.check-workflows.outputs.result).success == true &&
          steps.skip-check.outputs.should_skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER='${{ fromJSON(steps.check-workflows.outputs.result).pr_number }}'
          
          echo "✅ All checks passed for PR #$PR_NUMBER"
          echo "Approving and enabling auto-merge..."
          
          # Approve the PR
          gh pr review "$PR_NUMBER" --repo ${{ github.repository }} --approve \
            --body "✅ Auto-approved: All workflows passed
          
          - Unit Tests: ✅ Passed (≥95% overall coverage, all files ≥93%)
          - E2E Tests: ✅ Passed (100% of tools tested)"
          
          # Enable auto-merge
          gh pr merge "$PR_NUMBER" --repo ${{ github.repository }} --auto --squash

      - name: Comment on skipped PR
        if: |
          fromJSON(steps.check-workflows.outputs.result).success == true &&
          steps.skip-check.outputs.should_skip == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER='${{ fromJSON(steps.check-workflows.outputs.result).pr_number }}'
          SKIP_REASON='${{ steps.skip-check.outputs.skip_reason }}'
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} \
            --body "⚠️ Auto-merge skipped: $SKIP_REASON"

      - name: Comment on failed workflows
        if: fromJSON(steps.check-workflows.outputs.result).success == false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER='${{ github.event.pull_request.number }}'
          REASON='${{ fromJSON(steps.check-workflows.outputs.result).reason }}'
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} \
            --body "❌ Auto-merge cancelled: $REASON"
